generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  avatarUrl    String?   // null = Ð½ÐµÑ‚ Ð°Ð²Ð°Ñ‚Ð°Ñ€Ð°
  createdAt    DateTime  @default(now())

  sessions   Session[]
  workspaces Workspace[]
  cards      Card[]
  tools      Tool[]
  roadmaps   Roadmap[]
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Workspace {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  icon        String?  // Ð¾Ð´Ð¸Ð½ ÑÐ¼Ð¾Ð´Ð·Ð¸, Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ "ðŸ“"
  pinned      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ownerId     String

  owner    User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  columns  Column[]
  cards    Card[]
  tools    Tool[]
  roadmap Roadmap?

  @@index([ownerId])
}

model Column {
  id            String  @id @default(cuid())
  title         String
  order         Int
  hideCompleted Boolean @default(false)
  workspaceId   String

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  cards     Card[]

  @@index([workspaceId])
}

model Card {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId     String
  workspaceId String?  // null => "Ñ…Ð°Ð±" Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  columnId    String?  // null => Ð½Ðµ Ð½Ð° Ð´Ð¾ÑÐºÐµ (Ñ…Ð°Ð± Ð¸Ð»Ð¸ backlog)
  order       Int?     // Ð¸Ð¼ÐµÐµÑ‚ ÑÐ¼Ñ‹ÑÐ» Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ columnId != null

  type    CardType
  title   String?
  done    Boolean @default(false)

  payload Json
  tags    Json    @default("[]") // MySQL: Ð¼Ð°ÑÑÐ¸Ð² ÑÑ‚Ñ€Ð¾Ðº ÐºÐ°Ðº JSON

  learningStatus LearningStatus? // ÐÐ¾Ð²Ð¾Ðµ Ð¿Ð¾Ð»Ðµ: ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  column    Column?    @relation(fields: [columnId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([workspaceId])
  @@index([columnId])
  @@index([type])
  @@index([columnId, order])
  @@index([learningStatus])
}

model Tool {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId     String
  workspaceId String? // null => "Ñ…Ð°Ð±" (Ð¾Ð±Ñ‰Ð¸Ð¹ toolbox)

  title       String
  link        String?
  description String? @db.Text
  icon        String?
  tags        Json    @default("[]")

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([workspaceId])
}

model Roadmap {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId     String
  workspaceId String   @unique

  title       String
  sourceText  String?  @db.LongText

  owner     User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  workspace Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  nodes     RoadmapNode[]

  @@index([ownerId])
}

model RoadmapNode {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roadmapId String
  parentId  String?  // null => root node

  order     Int      @default(0)
  title     String
  done      Boolean  @default(false)

  roadmap  Roadmap       @relation(fields: [roadmapId], references: [id], onDelete: Cascade)
  parent   RoadmapNode?  @relation("NodeTree", fields: [parentId], references: [id], onDelete: Cascade)
  children RoadmapNode[] @relation("NodeTree")

  @@index([roadmapId])
  @@index([parentId])
  @@index([roadmapId, parentId, order])
}

enum CardType {
  note
  link
  checklist
}

enum LearningStatus {
  want_to_repeat
  questions_remain
  deepen_knowledge
}

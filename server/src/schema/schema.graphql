scalar DateTime

type User {
  id: ID!
  email: String!
  avatarUrl: String
  createdAt: DateTime!
  workspaces: [Workspace!]!
}

type Workspace {
  id: ID!
  title: String!
  description: String
  icon: String
  pinned: Boolean!
  """Токен пригласительной ссылки (виден только владельцу)."""
  inviteToken: String
  """Кто сейчас редактирует воркспейс (userId)."""
  editingBy: ID
  """Email/имя того, кто редактирует (resolved)."""
  editingUser: User
  createdAt: DateTime!
  updatedAt: DateTime!
  owner: User!
  """Участники воркспейса (кроме владельца)."""
  members: [WorkspaceMember!]!
  columns: [Column!]!
  cards: [Card!]!
  """Карточки воркспейса без колонки (backlog)."""
  backlog: [Card!]!
  """Инструменты воркспейса."""
  tools: [Tool!]!
  """Роадмап воркспейса (один на воркспейс)."""
  roadmap: Roadmap
}

type WorkspaceMember {
  id: ID!
  userId: ID!
  user: User!
  joinedAt: DateTime!
}

type Column {
  id: ID!
  title: String!
  order: Int!
  hideCompleted: Boolean!
  color: String
  workspace: Workspace!
  cards: [Card!]!
}

enum CardType {
  note
  link
  checklist
}

enum LearningStatus {
  in_progress
  want_to_repeat
  questions_remain
  deepen_knowledge
}

type Card {
  id: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
  ownerId: ID!
  workspaceId: ID
  columnId: ID
  order: Int
  type: CardType!
  title: String
  done: Boolean!
  payload: String!
  tags: [String!]!
  learningStatus: LearningStatus
  owner: User!
  workspace: Workspace
  column: Column
}

type Tool {
  id: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
  ownerId: ID!
  workspaceId: ID
  title: String!
  link: String
  description: String
  icon: String
  tags: [String!]!
  owner: User!
  workspace: Workspace
}

type Roadmap {
  id: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
  ownerId: ID!
  workspaceId: ID!
  title: String!
  sourceText: String
  nodes: [RoadmapNode!]!
}

type RoadmapNode {
  id: ID!
  createdAt: DateTime!
  updatedAt: DateTime!
  roadmapId: ID!
  parentId: ID
  order: Int!
  title: String!
  done: Boolean!
  children: [RoadmapNode!]!
}

type AuthPayload {
  user: User!
  token: String
}

"""Публичная статистика пользователя (доступна любому авторизованному)."""
type UserStats {
  id: ID!
  avatarUrl: String
  """Всего выполненных карточек (done = true)."""
  totalCompletedCards: Int!
  """Воркспейсы пользователя с прогрессом (без доступа к контенту)."""
  workspaceStats: [WorkspaceStatsItem!]!
}

"""Воркспейс с агрегатами: выполнено / всего карточек."""
type WorkspaceStatsItem {
  id: ID!
  title: String!
  description: String
  icon: String
  totalCards: Int!
  completedCards: Int!
}

# Inputs

input CreateWorkspaceInput {
  title: String!
  description: String
  icon: String
}

input UpdateWorkspaceInput {
  title: String
  description: String
  icon: String
}

input CreateCardInput {
  type: CardType!
  title: String
  workspaceId: ID
  columnId: ID
  payload: String
  tags: [String!]
  learningStatus: LearningStatus
}

input UpdateCardInput {
  title: String
  done: Boolean
  columnId: ID
  order: Int
  payload: String
  tags: [String!]
  learningStatus: LearningStatus
}

input CardFilter {
  type: CardType
  done: Boolean
  workspaceId: ID
  columnId: ID
  search: String
  learningStatus: LearningStatus
}

input CreateToolInput {
  workspaceId: ID
  title: String!
  link: String
  description: String
  icon: String
  tags: [String!]
}

input UpdateToolInput {
  title: String
  link: String
  description: String
  icon: String
  tags: [String!]
}

# Queries

type Query {
  me: User
  workspace(id: ID!): Workspace
  myWorkspaces: [Workspace!]!
  """Все карточки пользователя (хаб: workspaceId = null, или по фильтру). sortOrder: createdAt_DESC (по умолчанию) | createdAt_ASC"""
  cards(filter: CardFilter, limit: Int, offset: Int, sortOrder: String): [Card!]!
  """Число карточек по фильтру (для пагинации)."""
  cardsCount(filter: CardFilter): Int!
  card(id: ID!): Card
  """Публичная статистика пользователя по id (любой авторизованный может запросить)."""
  userStats(userId: ID!): UserStats
  """Инструменты пользователя (хаб: workspaceId = null)."""
  tools(workspaceId: ID): [Tool!]!
  """Все инструменты пользователя (все воркспейсы + хаб)."""
  allTools: [Tool!]!

  """Роадмап воркспейса (один на воркспейс)."""
  roadmap(workspaceId: ID!): Roadmap
}

# Mutations

type Mutation {
  # Auth
  signUp(email: String!, password: String!): AuthPayload!
  signIn(email: String!, password: String!): AuthPayload!
  signOut: Boolean!
  updateProfile(avatarUrl: String): User!

  # Workspace
  createWorkspace(input: CreateWorkspaceInput!): Workspace!
  updateWorkspace(id: ID!, input: UpdateWorkspaceInput!): Workspace!
  deleteWorkspace(id: ID!): Boolean!
  toggleWorkspacePinned(id: ID!): Workspace!

  # Workspace sharing
  """Сгенерировать (или перегенерировать) пригласительную ссылку."""
  generateInviteToken(workspaceId: ID!): Workspace!
  """Принять приглашение по токену. Возвращает воркспейс."""
  acceptInvite(token: String!): Workspace!
  """Удалить участника из воркспейса (только владелец)."""
  removeWorkspaceMember(workspaceId: ID!, userId: ID!): Boolean!

  # Workspace editing lock
  """Захватить лок на редактирование воркспейса."""
  acquireWorkspaceLock(workspaceId: ID!): Workspace!
  """Отпустить лок."""
  releaseWorkspaceLock(workspaceId: ID!): Workspace!
  """Heartbeat — продлить лок (вызывать каждые ~15с)."""
  heartbeatWorkspaceLock(workspaceId: ID!): Workspace!

  # Column
  createColumn(workspaceId: ID!, title: String!): Column!
  updateColumn(id: ID!, title: String, hideCompleted: Boolean, color: String): Column!
  deleteColumn(id: ID!): Boolean!
  reorderColumns(workspaceId: ID!, columnIds: [ID!]!): [Column!]!

  # Card
  createCard(input: CreateCardInput!): Card!
  updateCard(id: ID!, input: UpdateCardInput!): Card!
  deleteCard(id: ID!): Boolean!
  moveCard(id: ID!, columnId: ID, order: Int!): Card!

  # Tool
  createTool(input: CreateToolInput!): Tool!
  updateTool(id: ID!, input: UpdateToolInput!): Tool!
  deleteTool(id: ID!): Boolean!

  # Roadmap
  createRoadmap(workspaceId: ID!, title: String!, sourceText: String): Roadmap!
  deleteRoadmap(id: ID!): Boolean!
  createRoadmapNode(roadmapId: ID!, parentId: ID, title: String!): RoadmapNode!
  updateRoadmapNode(id: ID!, title: String, done: Boolean): RoadmapNode!
  deleteRoadmapNode(id: ID!): Boolean!
  reorderRoadmapNodes(roadmapId: ID!, parentId: ID, nodeIds: [ID!]!): [RoadmapNode!]!
}
